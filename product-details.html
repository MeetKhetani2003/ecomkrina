<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Product Details - Redstore</title>

    <link rel="stylesheet" href="style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
    />

    <style>
      body {
        font-family: "Poppins", sans-serif;
      }

      .single-product {
        display: flex;
        gap: 50px;
        align-items: center;
        margin: 60px 0;
      }

      .single-product img {
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }

      .product-info h1 {
        font-size: 28px;
        margin-bottom: 10px;
      }

      .product-info h4 {
        font-size: 22px;
        color: #ff523b;
        margin-bottom: 15px;
      }

      .stock-label {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 13px;
        margin-bottom: 15px;
      }

      .stock-in {
        background: #e6f9ed;
        color: #27ae60;
      }
      .stock-out {
        background: #ffeaea;
        color: #e74c3c;
      }

      .btn {
        padding: 10px 22px;
        border-radius: 30px;
        border: none;
        cursor: pointer;
        font-weight: 500;
        transition: 0.3s;
      }

      .btn-primary {
        background: #ff523b;
        color: white;
      }
      .btn-primary:hover {
        background: #e8432e;
      }

      .btn-outline {
        background: white;
        border: 2px solid #ff523b;
        color: #ff523b;
      }

      .btn-outline:hover {
        background: #ff523b;
        color: white;
      }

      .rating i {
        color: #ffcc00;
        cursor: pointer;
        font-size: 18px;
      }

      .recommended-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 30px;
      }

      .recommended-card {
        border: 1px solid #eee;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        transition: 0.3s;
      }

      .recommended-card:hover {
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        transform: translateY(-5px);
      }

      .recommended-card img {
        height: 150px;
        object-fit: cover;
        margin-bottom: 10px;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="navbar">
        <div class="logo">
          <a href="index.html"><img src="images/logo.png" width="125px" /></a>
        </div>
        <nav>
          <ul id="MenuItems">
            <li><a href="index.html">Home</a></li>
            <li><a href="products.html">Products</a></li>
            <li><a href="wishlist.html">Wishlist</a></li>
            <li><a href="profile.html">Profile</a></li>
            <li><a href="account.html">Account</a></li>
          </ul>
        </nav>
        <a href="cart.html"><img src="images/cart.png" width="30" /></a>
      </div>
    </div>

    <div class="small-container">
      <div class="single-product">
        <div>
          <img id="productImage" width="400" />
        </div>

        <div class="product-info">
          <h1 id="productTitle"></h1>
          <h4 id="productPrice"></h4>
          <div class="rating" id="productRating"></div>
          <div id="stockStatus" class="stock-label"></div>
          <p id="productDescription"></p>

          <br />
          <button id="cartBtn" class="btn btn-primary" onclick="addToCart()">
            Add to Cart
          </button>
          <button
            id="wishlistBtn"
            class="btn btn-outline"
            onclick="toggleWishlist()"
          >
            Add to Wishlist
          </button>
        </div>
      </div>

      <h2 class="title">Recommended Products</h2>
      <div id="recommendedProducts" class="recommended-grid"></div>
    </div>

    <script>
      function generateStars(rating) {
        let html = "";
        rating = parseInt(rating) || 0;
        for (let i = 1; i <= 5; i++) {
          html += `<i class="fa ${i <= rating ? "fa-star" : "fa-star-o"}" onclick="rateProduct(${i})"></i>`;
        }
        return html;
      }
      async function syncWishlistButton(productId) {
        const wishlistBtn = document.getElementById("wishlistBtn");

        try {
          const res = await fetch("/api/wishlist/" + productId, {
            credentials: "include",
          });

          if (!res.ok) {
            wishlistBtn.innerText = "Add to Wishlist";
            wishlistBtn.disabled = false;
            return;
          }

          const data = await res.json();

          if (data.inWishlist) {
            wishlistBtn.innerText = "âœ“ Already in Wishlist";
            wishlistBtn.disabled = true;
            wishlistBtn.classList.remove("btn-outline");
            wishlistBtn.classList.add("btn-primary");
          } else {
            wishlistBtn.innerText = "Add to Wishlist";
            wishlistBtn.disabled = false;
          }
        } catch (err) {
          console.error(err);
        }
      }
      document.addEventListener("DOMContentLoaded", async () => {
        const id = new URLSearchParams(window.location.search).get("id");
        const res = await fetch("/api/products/" + id);
        const product = await res.json();

        window.currentProduct = product;

        document.getElementById("productImage").src = product.image;
        document.getElementById("productTitle").innerText = product.title;
        document.getElementById("productPrice").innerText = "$" + product.price;
        document.getElementById("productDescription").innerText =
          product.description;
        document.getElementById("productRating").innerHTML = generateStars(
          product.Rating,
        );

        const stockStatus = document.getElementById("stockStatus");
        if (product.stock > 0) {
          stockStatus.className = "stock-label stock-in";
          stockStatus.innerText = "In stock (" + product.stock + ")";
        } else {
          stockStatus.className = "stock-label stock-out";
          stockStatus.innerText = "Out of stock";
          document.getElementById("cartBtn").disabled = true;
        }

        renderRecommended(product.recommended || []);
        syncWishlistButton(product.id);
      });

      function renderRecommended(products) {
        const container = document.getElementById("recommendedProducts");
        container.innerHTML = "";
        products.forEach((p) => {
          container.innerHTML += `
      <div class="recommended-card" onclick="location.href='product-details.html?id=${p.id}'">
        <img src="${p.image}">
        <h4>${p.title}</h4>
        <p>$${p.price}</p>
      </div>
    `;
        });
      }

      async function addToCart() {
        const product = window.currentProduct;
        const res = await fetch("/api/cart", {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ product_id: product.id, quantity: 1 }),
        });

        if (!res.ok) {
          alert("Please login first");
          location.href = "account.html";
          return;
        }

        alert("Added to cart!");
      }

      async function toggleWishlist() {
        const product = window.currentProduct;

        const res = await fetch("/api/wishlist", {
          method: "POST",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ product_id: product.id }),
        });

        if (!res.ok) {
          alert("Please login first");
          location.href = "account.html";
          return;
        }

        await syncWishlistButton(product.id);
        alert("Added to wishlist!");
      }
      async function rateProduct(value) {
        const product = window.currentProduct;

        const res = await fetch("/api/products/" + product.id + "/rating", {
          method: "PUT",
          credentials: "include",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ Rating: value }),
        });

        if (!res.ok) {
          alert("Login required");
          location.href = "account.html";
          return;
        }

        document.getElementById("productRating").innerHTML =
          generateStars(value);
      }
    </script>
  </body>
</html>
