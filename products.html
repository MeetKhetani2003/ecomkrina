<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Products - Redstore</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@200;300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

</head>

<body>
    <div class="container">
        <div class="navbar">
            <div class="logo">
                <a href="index.html"><img src="images/logo.png" width="125px"></a>
            </div>
            <nav>
                <ul id="MenuItems">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="products.html">Products</a></li>
                    <li><a href="About.html">About</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
            </nav>
            <div class="nav-icons">
                <a href="wishlist.html" title="Wishlist"><i class="fa fa-heart-o"></i></a>
                <a href="profile.html" title="Profile"><i class="fa fa-user"></i></a>
                <a href="cart.html" title="Cart"><i class="fa fa-shopping-cart"></i></a>
            </div>
            <img src="images/menu.png" class="menu-icon" onClick="menutoggle()">
        </div>

    </div>

    <div class="small-container">
        <h2 class="title">Products</h2>
        <div class="filters-row">
            <input id="searchFilter" placeholder="Search product..." />
            <input id="minPriceFilter" type="number" min="0" placeholder="Min price" />
            <input id="maxPriceFilter" type="number" min="0" placeholder="Max price" />
            <select id="stockFilter">
                <option value="all">All</option>
                <option value="in">In stock</option>
                <option value="out">Out of stock</option>
            </select>
        </div>
        <div class="row" id="productList"></div>
    </div>

    <div class="footer">
        <div class="container" style="text-align:center;">
            <div class="footer-col-2">
                <img src="images/logo-white.png" alt="Logo" style="max-width:160px;">
                <p>Our Purpose Is To Sustainably Make the Pleasure and Benefits of Sports Accessible to the Many.</p>
            </div>

            <script>
                var menuItems = document.getElementById("MenuItems");

                MenuItems.style.maxHeight = "0px";
                function menutoggle() {
                    if (MenuItems.style.maxHeight == "0px") {
                        MenuItems.style.maxHeight = "260px";
                    }
                    else {
                        MenuItems.style.maxHeight = "0px";
                    }
                }
            </script>
            <script>
                function generateStars(rating) {
                    let starsHTML = "";
                    rating = parseInt(rating) || 0;

                    for (let i = 1; i <= 5; i++) {
                        if (i <= rating) {
                            starsHTML += '<i class="fa fa-star"></i>';
                        } else {
                            starsHTML += '<i class="fa fa-star-o"></i>';
                        }
                    }

                    return starsHTML;
                }

                let allProducts = [];

                function renderProducts() {
                    const container = document.getElementById("productList");
                    const query = document.getElementById("searchFilter").value.toLowerCase().trim();
                    const minPrice = Number(document.getElementById("minPriceFilter").value || 0);
                    const maxPrice = Number(document.getElementById("maxPriceFilter").value || 0);
                    const stockFilter = document.getElementById("stockFilter").value;

                    const products = allProducts.filter((product) => {
                        const titleOk = product.title.toLowerCase().includes(query);
                        const minOk = Number(product.price) >= minPrice;
                        const maxOk = maxPrice ? Number(product.price) <= maxPrice : true;
                        const stockOk = stockFilter === "all"
                            || (stockFilter === "in" && product.stock > 0)
                            || (stockFilter === "out" && product.stock <= 0);

                        return titleOk && minOk && maxOk && stockOk;
                    });

                    let html = "";

                    products.forEach(product => {
                        html += `
                <div class="col-4 product-card">
                    <div onclick="goToProduct(${product.id})" style="cursor:pointer">
                        <img src="${product.image}" alt="${product.title}">
                        <h4>${product.title}</h4>
                        <div class="rating">
                            ${generateStars(product.Rating)}
                        </div>
                        <p>$${product.price}</p>
                        <p class="stock-label ${product.stock > 0 ? "stock-in" : "stock-out"}">
                          ${product.stock > 0 ? `In stock (${product.stock})` : "Out of stock"}
                        </p>
                    </div>

                    <button class="btn add-btn"
                        onclick="addToCart(event, ${product.id})"
                        ${product.stock <= 0 ? "disabled" : ""}>
                        ${product.stock <= 0 ? "Out of stock" : "Add to Cart"}
                    </button>
                </div>
            `;
                    });

                    container.innerHTML = html || "<p>No products found for selected filters.</p>";
                }

                document.addEventListener("DOMContentLoaded", async () => {
                    try {
                        const res = await fetch("/api/products");
                        allProducts = await res.json();
                        renderProducts();

                        ["searchFilter", "minPriceFilter", "maxPriceFilter", "stockFilter"].forEach((id) => {
                            document.getElementById(id).addEventListener("input", renderProducts);
                            document.getElementById(id).addEventListener("change", renderProducts);
                        });
                    } catch (error) {
                        console.error("Error loading products:", error);
                    }
                });

                function goToProduct(id) {
                    window.location.href = "product-details.html?id=" + id;
                }

                async function addToCart(event, productId) {

                    event.stopPropagation();

                    try {
                        const response = await fetch("/api/cart", {
                            method: "POST",
                            credentials: "include",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                product_id: productId,
                                quantity: 1
                            })
                        });

                        const data = await response.json();

                        if (!response.ok) {
                            alert(data.message || "Please login first");
                            if (response.status === 401) window.location.href = "account.html";
                            return;
                        }

                        alert("Added to cart successfully!");

                    } catch (err) {
                        console.error(err);
                        alert("Error adding to cart");
                    }
                }
            </script>

</body>

</html>
